<!DOCTYPE html>
<html>

<head>
	<title>Image Audio to Video</title>
	<style>
		body {
			font-family: sans-serif;
		}
	</style>

</head>

<body>

	<h1>Image and Audio to Video converter</h1>

	<input type="file" id="imageInput" accept="image/*">
	<img id="imagePreview" width="320" height="240" style="display: none;">
	<input type="file" id="audioInput" accept="audio/*">
	<audio id="audioPreview" controls style="display: none;"></audio>

	<button id="createBtn" disabled>Create Video</button>

	<progress id="progressBar" value="0" max="100"></progress>

	<video id="videoPreview" width="320" height="240" controls style="display: none;"></video>

	<button id="downloadBtn" style="display: none;">Download Video</button>

	<script type="module">
		// Load ffmpeg.wasm
		import { fetchFile } from "/node_modules/@ffmpeg/util/dist/esm/index.js";
		import { FFmpeg } from "/node_modules/@ffmpeg/ffmpeg/dist/esm/index.js";


		const baseURL = '/node_modules/@ffmpeg/core/dist/esm';
		const ffmpeg = new FFmpeg()
		await ffmpeg.load({
			coreURL: await `${baseURL}/ffmpeg-core.js`,
			wasmURL: await `${baseURL}/ffmpeg-core.wasm`,
			workerURL: await `${baseURL}/ffmpeg-core.worker.js`,
		});


		const imageInput = document.getElementById('imageInput');
		const audioInput = document.getElementById('audioInput');
		const createBtn = document.getElementById('createBtn');
		const downloadBtn = document.getElementById('downloadBtn');
		const progressBar = document.getElementById('progressBar');
		const imagePreview = document.getElementById('imagePreview');
		const audioPreview = document.getElementById('audioPreview');
		const videoPreview = document.getElementById('videoPreview');

		let imageData;
		let audioData;
		let videoData;

		imageInput.addEventListener('change', async (e) => {
			const file = e.target.files[0];
			imageData = await fetchFile(file);
			if(imageData && audioData){
				createBtn.disabled = false;
			}
			const imageUrl = URL.createObjectURL(file);
			imagePreview.src = imageUrl;
			imagePreview.style.display = 'block';
		});

		audioInput.addEventListener('change', async (e) => {
			const file = e.target.files[0];
			audioData = await fetchFile(file);
			if(imageData && audioData){
				createBtn.disabled = false;
			}
			const audioUrl = URL.createObjectURL(file);
			audioPreview.src = audioUrl;
			audioPreview.style.display = 'block';
		});

		downloadBtn.addEventListener('click', () => {
			const url = URL.createObjectURL(new Blob([videoData], { type: 'video/mp4' }));
			const link = document.createElement('a');
			link.href = url;
			link.download = 'video.mp4';
			link.click();
		});

		createBtn.addEventListener('click', createVideo);

		async function createVideo() {
			if (!imageData || !audioData) {
				alert('Please select both an image and an audio file.');
				return;
			}

			ffmpeg.writeFile('image.png', new Uint8Array(imageData));
			ffmpeg.writeFile('audio.mp3', new Uint8Array(audioData));

			console.log("converting");
			await ffmpeg.exec(["-loop","1","-i","image.png","-i","audio.mp3","-tune","stillimage","-shortest","video.mp4"]);
			console.log("converted");

			//await ffmpeg.exec('-loop', '1', '-i', 'image.jpg', '-i', 'audio.mp3', '-c:v', 'libx264', '-tune', 'stillimage', '-c:a', 'aac', '-b:a', '192k', '-pix_fmt', 'yuv420p', '-shortest', 'output.mp4');

			videoData = await ffmpeg.readFile('video.mp4');
			const videoUrl = URL.createObjectURL(new Blob([videoData.buffer], { type: 'video/mp4' }));
			videoPreview.src = videoUrl;
			videoPreview.style.display = 'block';

			downloadBtn.style.display = 'block';
		}

		ffmpeg.on("log", ({ message }) => {
			console.log(message);
		});

		ffmpeg.on("progress", ({ progress, time }) => {
			progressBar.value = progress * 100;
		});
	</script>

</body>

</html>